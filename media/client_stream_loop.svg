<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: ClientStreamLoop Pages: 1 -->
<svg width="2379pt" height="244pt"
 viewBox="0.00 0.00 2379.16 244.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 240)">
<title>ClientStreamLoop</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-240 2375.16,-240 2375.16,4 -4,4"/>
<!-- start -->
<g id="node1" class="node">
<title>start</title>
<polygon fill="none" stroke="black" points="315.26,-98 64.44,-98 -0.09,-22 250.74,-22 315.26,-98"/>
<text text-anchor="middle" x="157.59" y="-63.8" font-family="Times,serif" font-size="14.00">fetch POST</text>
<text text-anchor="middle" x="157.59" y="-48.8" font-family="Times,serif" font-size="14.00">/agent/chat/stream</text>
</g>
<!-- ok -->
<g id="node2" class="node">
<title>ok</title>
<polygon fill="none" stroke="black" points="481.77,-78 352.07,-60 481.77,-42 611.48,-60 481.77,-78"/>
<text text-anchor="middle" x="481.77" y="-56.3" font-family="Times,serif" font-size="14.00">HTTP ok + body?</text>
</g>
<!-- start&#45;&gt;ok -->
<g id="edge1" class="edge">
<title>start&#45;&gt;ok</title>
<path fill="none" stroke="black" d="M283.15,-60C302.38,-60 322.34,-60 341.85,-60"/>
<polygon fill="black" stroke="black" points="342.01,-63.5 352.01,-60 342.01,-56.5 342.01,-63.5"/>
</g>
<!-- reader -->
<g id="node3" class="node">
<title>reader</title>
<polygon fill="none" stroke="black" points="856.27,-117 712.27,-117 712.27,-81 856.27,-81 856.27,-117"/>
<text text-anchor="middle" x="784.27" y="-95.3" font-family="Times,serif" font-size="14.00">reader.read() loop</text>
</g>
<!-- ok&#45;&gt;reader -->
<g id="edge2" class="edge">
<title>ok&#45;&gt;reader</title>
<path fill="none" stroke="black" d="M549.46,-68.66C594.5,-74.5 654.22,-82.25 702.04,-88.46"/>
<polygon fill="black" stroke="black" points="701.68,-91.94 712.05,-89.76 702.58,-85 701.68,-91.94"/>
</g>
<!-- error -->
<g id="node9" class="node">
<title>error</title>
<polygon fill="none" stroke="black" points="903.05,-37.54 903.05,-52.46 833.47,-63 735.07,-63 665.48,-52.46 665.48,-37.54 735.07,-27 833.47,-27 903.05,-37.54"/>
<text text-anchor="middle" x="784.27" y="-41.3" font-family="Times,serif" font-size="14.00">Throw / surface error</text>
</g>
<!-- ok&#45;&gt;error -->
<g id="edge8" class="edge">
<title>ok&#45;&gt;error</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M577.44,-55.27C602.04,-54.05 628.96,-52.7 654.98,-51.4"/>
<polygon fill="black" stroke="black" points="655.47,-54.88 665.29,-50.89 655.12,-47.89 655.47,-54.88"/>
<text text-anchor="middle" x="638.38" y="-55.8" font-family="Times,serif" font-size="14.00">no</text>
</g>
<!-- buffer -->
<g id="node4" class="node">
<title>buffer</title>
<path fill="none" stroke="black" d="M1261.16,-236C1261.16,-236 1022.16,-236 1022.16,-236 1016.16,-236 1010.16,-230 1010.16,-224 1010.16,-224 1010.16,-194 1010.16,-194 1010.16,-188 1016.16,-182 1022.16,-182 1022.16,-182 1261.16,-182 1261.16,-182 1267.16,-182 1273.16,-188 1273.16,-194 1273.16,-194 1273.16,-224 1273.16,-224 1273.16,-230 1267.16,-236 1261.16,-236"/>
<text text-anchor="middle" x="1141.66" y="-220.8" font-family="Times,serif" font-size="14.00">append bytes → decode → split by </text>
<text text-anchor="middle" x="1141.66" y="-189.8" font-family="Times,serif" font-size="14.00">keep tail in buffer</text>
</g>
<!-- reader&#45;&gt;buffer -->
<g id="edge3" class="edge">
<title>reader&#45;&gt;buffer</title>
<path fill="none" stroke="black" d="M837.75,-117.07C883.18,-132.52 950.75,-155.04 1010.16,-173 1016.96,-175.06 1023.98,-177.13 1031.07,-179.19"/>
<polygon fill="black" stroke="black" points="1030.18,-182.58 1040.76,-181.98 1032.12,-175.85 1030.18,-182.58"/>
</g>
<!-- finish -->
<g id="node8" class="node">
<title>finish</title>
<polygon fill="none" stroke="black" points="1206.66,-164 1076.66,-164 1076.66,-34 1206.66,-34 1206.66,-164"/>
<polyline fill="none" stroke="black" points="1088.66,-164 1076.66,-152 "/>
<polyline fill="none" stroke="black" points="1076.66,-46 1088.66,-34 "/>
<polyline fill="none" stroke="black" points="1194.66,-34 1206.66,-46 "/>
<polyline fill="none" stroke="black" points="1206.66,-152 1194.66,-164 "/>
<text text-anchor="middle" x="1141.66" y="-95.3" font-family="Times,serif" font-size="14.00">Stream finished</text>
</g>
<!-- reader&#45;&gt;finish -->
<g id="edge9" class="edge">
<title>reader&#45;&gt;finish</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M856.33,-99C917.25,-99 1004.71,-99 1066.51,-99"/>
<polygon fill="black" stroke="black" points="1066.58,-102.5 1076.58,-99 1066.58,-95.5 1066.58,-102.5"/>
<text text-anchor="middle" x="956.66" y="-102.8" font-family="Times,serif" font-size="14.00">done? yes</text>
</g>
<!-- parse -->
<g id="node5" class="node">
<title>parse</title>
<polygon fill="none" stroke="black" points="1605.16,-207 1310.16,-207 1310.16,-171 1605.16,-171 1605.16,-207"/>
<text text-anchor="middle" x="1457.66" y="-185.3" font-family="Times,serif" font-size="14.00">if line starts with &#39;data: &#39; → JSON.parse</text>
</g>
<!-- buffer&#45;&gt;parse -->
<g id="edge4" class="edge">
<title>buffer&#45;&gt;parse</title>
<path fill="none" stroke="black" d="M1273.55,-200.66C1282.29,-200.11 1291.14,-199.54 1299.99,-198.98"/>
<polygon fill="black" stroke="black" points="1300.22,-202.47 1309.98,-198.34 1299.78,-195.49 1300.22,-202.47"/>
</g>
<!-- dispatch -->
<g id="node6" class="node">
<title>dispatch</title>
<polygon fill="none" stroke="black" points="2120.16,-150 1642.16,-150 1642.16,-112 2126.16,-112 2126.16,-144 2120.16,-150"/>
<polyline fill="none" stroke="black" points="2120.16,-150 2120.16,-144 "/>
<polyline fill="none" stroke="black" points="2126.16,-144 2120.16,-144 "/>
<text text-anchor="middle" x="1884.16" y="-134.8" font-family="Times,serif" font-size="14.00">dispatch by evt.type:</text>
<text text-anchor="middle" x="1884.16" y="-119.8" font-family="Times,serif" font-size="14.00">content_stream | tool_start | tool_complete | heartbeat | complete</text>
</g>
<!-- parse&#45;&gt;dispatch -->
<g id="edge5" class="edge">
<title>parse&#45;&gt;dispatch</title>
<path fill="none" stroke="black" d="M1590.64,-170.97C1635.99,-164.77 1687.07,-157.79 1733.71,-151.42"/>
<polygon fill="black" stroke="black" points="1734.47,-154.85 1743.9,-150.03 1733.52,-147.91 1734.47,-154.85"/>
</g>
<!-- update -->
<g id="node7" class="node">
<title>update</title>
<polygon fill="none" stroke="black" points="2371.16,-36 2163.16,-36 2163.16,0 2371.16,0 2371.16,-36"/>
<text text-anchor="middle" x="2267.16" y="-14.3" font-family="Times,serif" font-size="14.00">UI updates / state changes</text>
</g>
<!-- dispatch&#45;&gt;update -->
<g id="edge6" class="edge">
<title>dispatch&#45;&gt;update</title>
<path fill="none" stroke="black" d="M1949.36,-111.96C2017.51,-91.74 2124.93,-59.89 2195.46,-38.97"/>
<polygon fill="black" stroke="black" points="2196.57,-42.29 2205.16,-36.09 2194.58,-35.58 2196.57,-42.29"/>
</g>
<!-- update&#45;&gt;reader -->
<g id="edge7" class="edge">
<title>update&#45;&gt;reader</title>
<path fill="none" stroke="black" d="M2163.1,-13C2086.45,-9.71 1979.29,-6 1885.16,-6 1140.66,-6 1140.66,-6 1140.66,-6 1082.04,-6 1066.5,-8.85 1010.16,-25 960.23,-39.32 952.47,-55.69 903.16,-72 891.36,-75.9 878.72,-79.44 866.25,-82.58"/>
<polygon fill="black" stroke="black" points="865.19,-79.24 856.31,-85.01 866.85,-86.04 865.19,-79.24"/>
</g>
</g>
</svg>
